---
title: "Untitled"
output: html_document
date: "2024-11-09"
---

```{r}
setwd("/Users/jacobrichards/Desktop/DS assesment/DS_Exam_2")
transactions <- read.csv(file="transactions(1).csv",header=TRUE)

#setwd("C:/Users/jake pc/Desktop/DS_Exam_2")
#transactions <- read.csv(file="transactions(1).csv",header=TRUE)
```

```{r}
failure_percent <- numeric(nrow(transactions))
failure_percent <- (1 - transactions[,2]/transactions[,1])*100
transactions$failure_percent <- failure_percent

transactions <- transactions[order(as.POSIXct(transactions[,7], format = "%Y-%m-%d %H")),]
unique_hours <- unique(transactions[,7])

percentage_of_failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  percentage_of_failed_transactions_per_hour[i] <- ( 1 - sum(transactions[transactions[,7] == unique_hours[i],2])/sum(transactions[transactions[,7] == unique_hours[i],1]))
}

failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  failed_transactions_per_hour[i] <- sum(transactions[transactions[,7] == unique_hours[i],1]) - sum(transactions[transactions[,7] == unique_hours[i],2]) 
}

```

```{r,echo=FALSE}
library(dplyr)
unique_hours_df <- data.frame(unique_hour = unique_hours, index = 1:length(unique_hours))

transactions <- transactions %>%
  mutate(unique_hour = transactions[[7]]) %>%
  left_join(unique_hours_df, by = "unique_hour") %>%
  select(-unique_hour)  

transactions_original <- transactions 
```

```{r}
transactions$weighted_failure_score <- transactions[,9] * transactions[,1] *100

transactions$pmt <- as.numeric(as.factor(transactions$pmt))
transactions$pg <- as.numeric(as.factor(transactions$pg))
transactions$bank <- as.numeric(as.factor(transactions$bank))
transactions$sub_type <- as.numeric(as.factor(transactions$sub_type))

features <- transactions[, c("weighted_failure_score", "pmt", "pg", "bank", "sub_type")]

center <- colMeans(features)
cov_matrix <- cov(features)
mahalanobis_distances <- mahalanobis(features, center, cov_matrix)

transactions$mahalanobis_score <- mahalanobis_distances

threshold <- quantile(mahalanobis_distances, 0.999)
high_mahalanobis_transactions <- transactions[transactions$mahalanobis_score > threshold, ]

anamolous <- transactions_original[row.names(high_mahalanobis_transactions),]
anamolous
```
1.1.1 Which dimension combination caused the issue? Explore the data and visualization to understand when the issue (possibly a significant number of failures in transactions ) happened and which combination of dimension (pmt, pg, bank and sub_type) has the impact. Tip: Identify the method to detect an anomaly in a metric across 4+ dimensions and apply that method to find the above.


UPI	PAYTM_UPI	UPI_PAY UPI



```{r}
failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  failed_transactions_per_hour[i] <- sum(transactions[transactions[,7] == unique_hours[i],1]) - sum(transactions[transactions[,7] == unique_hours[i],2]) 
}

plot(x=seq(1,72,by=1),y=failed_transactions_per_hour,type="o")
title("failed_transactions_per_hour")

points(x=anamolous$index,y=failed_transactions_per_hour[anamolous$index],type="p",col="red")

hours <- unique_hours[anamolous$index]

percentage_of_failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  percentage_of_failed_transactions_per_hour[i] <- ( 1 - sum(transactions[transactions[,7] == unique_hours[i],2])/sum(transactions[transactions[,7] == unique_hours[i],1]))
}

plot(x=seq(1,72,by=1),y=percentage_of_failed_transactions_per_hour,type="o")
title("percentage_of_failed_transactions_per_hour")
points(x=anamolous$index,y=percentage_of_failed_transactions_per_hour[anamolous$index],type="p",col="red")

```

1.1.2 When did the issue happen? What is the starting hour and ending hour of the reported issue? Illustrate your answer with a plot

This is a sports betting website and alot of people defaulted when they lost the bet. The website needs to hold funds from the customer which can cover the maximal losses they owe if they lose to guarantee payment. 

UPI	PAYTM_UPI	UPI_PAY UPI - I image that these services are the only ones that would allow a user to place such a bet without the funds present to cover losses. 



```{r}
failures <- transactions_original[,1] - transactions_original[,2]
failures_set <- cbind(failures,transactions_original)

merchants <- table(anamolous[,3])

merchants_failures <- aggregate(failures_set$failures, by = list(failures_set$mid), FUN = sum)
merchants_t <- aggregate(failures_set$t, by = list(failures_set$mid), FUN = sum)

merchants_failure_rate <- merchants_failures[,2]/merchants_t[,2]

merchants_sums <- cbind(merchants_failures,merchants_failure_rate)
merchants_sums <- merchants_sums[order(merchants_sums[,2],decreasing = TRUE),]
merchants_sums <- as.data.frame(merchants_sums)
colnames(merchants_sums) <- c("merchant","failures","failure_rate")

library(ggplot2)

merchants_data <- merchants_sums

ggplot(merchants_data, aes(x = reorder(merchant, -failures), y = failures)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_line(aes(y = failure_rate * max(failures), group = 1), color = "red", size = 1) +
  geom_point(aes(y = failure_rate * max(failures)), color = "red", size = 2) +
  scale_y_continuous(
    name = "Number of Failures",
    sec.axis = sec_axis(~ . / max(merchants_data$failures), name = "Failure Rate")
  ) +
  labs(title = "Failures and Failure Rate by Merchant", x = "Merchant") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

1.1.3 For whom did the issue happen?
Which all merchants were impacted because of the issue and which all merchants were not? Illustrate your answer with a plot and a table.

All of the merchants were effected. The failure rates for the merchants were not significantly different from each other. The top two merchants had error events of significantly greater magnitude than the other merchants highlighting the relevant combination of predictor variables for the anomaly detection model.
