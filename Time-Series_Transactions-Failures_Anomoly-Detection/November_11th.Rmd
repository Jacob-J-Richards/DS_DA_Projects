---
title: "Untitled"
output: html_document
date: "2024-11-09"
---

```{r}
setwd("/Users/jacobrichards/Desktop/DS assesment/DS_Exam_2")
transactions <- read.csv(file="transactions(1).csv",header=TRUE)

#setwd("C:/Users/jake pc/Desktop/DS_Exam_2")
#transactions <- read.csv(file="transactions(1).csv",header=TRUE)

```

```{r}
failure_percent <- numeric(nrow(transactions))
failure_percent <- (1 - transactions[,2]/transactions[,1])*100
transactions$failure_percent <- failure_percent

transactions <- transactions[order(as.POSIXct(transactions[,7], format = "%Y-%m-%d %H")),]
(unique_hours <- unique(transactions[,7]))

transactions

percentage_of_failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  percentage_of_failed_transactions_per_hour[i] <- ( 1 - sum(transactions[transactions[,7] == unique_hours[i],2])/sum(transactions[transactions[,7] == unique_hours[i],1]))
}

failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  failed_transactions_per_hour[i] <- sum(transactions[transactions[,7] == unique_hours[i],1]) - sum(transactions[transactions[,7] == unique_hours[i],2]) 
}

plot(x=seq(1,72,by=1),y=failed_transactions_per_hour,type="o")

plot(x=seq(1,72,by=1),y=percentage_of_failed_transactions_per_hour,type="o")
```

```{r,echo=FALSE}
library(dplyr)
unique_hours_df <- data.frame(unique_hour = unique_hours, index = 1:length(unique_hours))

transactions <- transactions %>%
  mutate(unique_hour = transactions[[7]]) %>%
  left_join(unique_hours_df, by = "unique_hour") %>%
  select(-unique_hour)  

transactions_original <- transactions 
```

```{r}
transactions

transactions$weighted_failure_score <- transactions[,9] * transactions[,1] *100

transactions$pmt <- as.numeric(as.factor(transactions$pmt))
transactions$pg <- as.numeric(as.factor(transactions$pg))
transactions$bank <- as.numeric(as.factor(transactions$bank))
transactions$sub_type <- as.numeric(as.factor(transactions$sub_type))

# Select relevant features for anomaly detection
features <- transactions[, c("weighted_failure_score", "pmt", "pg", "bank", "sub_type")]

# Calculate the Mahalanobis distance for each observation
center <- colMeans(features)
cov_matrix <- cov(features)
mahalanobis_distances <- mahalanobis(features, center, cov_matrix)

# Append Mahalanobis distances to the transactions dataframe
transactions$mahalanobis_score <- mahalanobis_distances

# Determine a threshold for high anomaly scores (e.g., 95th percentile)
threshold <- quantile(mahalanobis_distances, 0.99)
high_mahalanobis_transactions <- transactions[transactions$mahalanobis_score > threshold, ]

# Display the top anomalous transactions
head(high_mahalanobis_transactions, 100)

anamolous <- transactions_original[row.names(high_mahalanobis_transactions),]

anamolous
```
1.1.1 Which dimension combination caused the issue? Explore the data and visualization to understand when the issue (possibly a significant number of failures in transactions ) happened and which combination of dimension (pmt, pg, bank and sub_type) has the impact. Tip: Identify the method to detect an anomaly in a metric across 4+ dimensions and apply that method to find the above.

The combination of dimensions which increased transaction failure rates was (pmt: UPI, PG:PAYTM_UPI/PAYTM_V2, sub_type: UPI_PAY, bank: UPI)
these are all services under the same company, so the problem is most certainly originating from the interaction of their services. 


on the 12th: 3AM to 3PM 

on the 13th: 4AM to 2PM 

on the 14th:4AM to 3PM

is where the numeracy of failures is notable 


```{r}
failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  failed_transactions_per_hour[i] <- sum(transactions[transactions[,7] == unique_hours[i],1]) - sum(transactions[transactions[,7] == unique_hours[i],2]) 
}

plot(x=seq(1,72,by=1),y=failed_transactions_per_hour,type="o")
title("failed_transactions_per_hour")

points(x=anamolous$index,y=failed_transactions_per_hour[anamolous$index],type="p",col="red")

hours <- unique_hours[anamolous$index]

(as.data.frame(hours))

percentage_of_failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  percentage_of_failed_transactions_per_hour[i] <- ( 1 - sum(transactions[transactions[,7] == unique_hours[i],2])/sum(transactions[transactions[,7] == unique_hours[i],1]))
}

plot(x=seq(1,72,by=1),y=percentage_of_failed_transactions_per_hour,type="o")
title("percentage_of_failed_transactions_per_hour")
points(x=anamolous$index,y=percentage_of_failed_transactions_per_hour[anamolous$index],type="p",col="red")

```

1.1.2 When did the issue happen? What is the starting hour and ending hour of the reported issue? Illustrate your answer with a plot

The issue being failure of the UPI services in interaction with each other was present in the entire duration of the data. 
The periods when the totall transaction failures were greatest were during normal business hours.
Febuary 12th, 2AM to 3PM , Febuary 13th, 4AM to 2PM, Febuary 14th, 4AM to 3PM

It appears that the issue got better on Febuary 14th because from the graph of failure percentage, the failure rate seems lower. However when you examine the numeracy of failures the pattern is exactly the same as the previous 2 days so all that happened is more users not using all UPI services were active that day. 



```{r}
failures <- transactions_original[,1] - transactions_original[,2]
failures_set <- cbind(failures,transactions_original)

anamolous
merchants <- table(anamolous[,3])

merchants_failures <- aggregate(failures_set$failures, by = list(failures_set$mid), FUN = sum)
merchants_t <- aggregate(failures_set$t, by = list(failures_set$mid), FUN = sum)

merchants_failure_rate <- merchants_failures[,2]/merchants_t[,2]


merchants_sums <- cbind(merchants_failures,merchants_failure_rate)
merchants_sums
merchants_sums <- merchants_sums[order(merchants_sums[,2],decreasing = TRUE),]
merchants_sums <- as.data.frame(merchants_sums)

merchants_sums 

```

1.1.3 For whom did the issue happen?
Which all merchants were impacted because of the issue and which all merchants were not? Illustrate your answer with a plot and a table.

All of the merchants were effected. 

