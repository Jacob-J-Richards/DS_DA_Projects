---
title: "Transaction Failures Anamoly Detection"
output:
  html_document: 
    keep_md: true
  pdf_document: default
date: "Completed November 12th 2024"
---
Given: the following Data sheet (abbreviated)

```{r,include=FALSE}
setwd("C:/Users/jake pc/Desktop/DS_Exam_2")
transactions <- read.csv(file="transactions(1).csv",header=TRUE)
```

```{r}
print(head(transactions,6))
```



Calculate and append failure totals and percentages by hour.

```{r}
failure_percent <- numeric(nrow(transactions))
failure_percent <- (1 - transactions[,2]/transactions[,1])*100
transactions$failure_percent <- failure_percent

transactions <- transactions[order(as.POSIXct(transactions[,7], format = "%Y-%m-%d %H")),]
unique_hours <- unique(transactions[,7])

percentage_of_failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  percentage_of_failed_transactions_per_hour[i] <- ( 1 - sum(transactions[transactions[,7] == unique_hours[i],2])/sum(transactions[transactions[,7] == unique_hours[i],1]))
}

failed_transactions_per_hour <- numeric(length(unique_hours))
for (i in 1:72) {
  failed_transactions_per_hour[i] <- sum(transactions[transactions[,7] == unique_hours[i],1]) - sum(transactions[transactions[,7] == unique_hours[i],2])
}
```

```{r,include=FALSE}
library('dplyr')
```

```{r}
unique_hours_df <- data.frame(unique_hour = unique_hours, index = 1:length(unique_hours))
transactions <- transactions %>%
  mutate(unique_hour = transactions[[7]]) %>%
  left_join(unique_hours_df, by = "unique_hour") %>%
  select(-unique_hour)  
transactions_original <- transactions 
```

Evaluate mahalanobis anamoly detection method.

```{r}
transactions$weighted_failure_score <- transactions[,9] * transactions[,1] *100 
transactions$pmt <- as.numeric(as.factor(transactions$pmt))
transactions$pg <- as.numeric(as.factor(transactions$pg))
transactions$bank <- as.numeric(as.factor(transactions$bank))
transactions$sub_type <- as.numeric(as.factor(transactions$sub_type))

features <- transactions[, c("weighted_failure_score", "pmt", "pg", "bank", "sub_type")]
center <- colMeans(features)
cov_matrix <- cov(features)
mahalanobis_distances <- mahalanobis(features, center, cov_matrix)

transactions$mahalanobis_score <- mahalanobis_distances
threshold <- quantile(mahalanobis_distances, 0.9997)
high_mahalanobis_transactions <- transactions[transactions$mahalanobis_score > threshold, ]

anamolous <- transactions_original[row.names(high_mahalanobis_transactions),]
```

```{r}
anamolous
```

Plot failed transactions per hour by line with red dots highlighting the top 6 anomalous observations.

```{r,include=FALSE}
library('ggplot2')
```

```{r,echo=FALSE}
failed_transactions_per_hour_anamoly <- failed_transactions_per_hour[anamolous$index]

failed_transactions <- data.frame(hours = unique_hours, failedTransactions = failed_transactions_per_hour, x_index = seq(1:72))

anomalous_data <- data.frame(hour_anamoly = anamolous$index,FailedTransactions_anamoly = failed_transactions_per_hour[anamolous$index])

ggplot(data = failed_transactions, aes(x = x_index, y = failedTransactions)) + 
  geom_area(fill = "blue", alpha = 0.25) + 
  geom_line(color = "black") +
  scale_x_continuous(
    breaks = seq(1, 72, by = 6), 
    labels = unique_hours[seq(1, length(unique_hours), by = 6)],
    minor_breaks = seq(1, 72, by = 1)  # Minor ticks at each integer hour
  ) + 
  geom_point(data = anomalous_data, aes(x = hour_anamoly, y = FailedTransactions_anamoly, color = "Top 6 Anomalous"), size = 2) + 
  geom_segment(data = anomalous_data, aes(x = hour_anamoly, xend = hour_anamoly, y = 0, yend = FailedTransactions_anamoly), color = "red", linetype = "dashed") +
  geom_point(aes(x = 45, y = 296, color = "Maximum % of Transaction Failure"), size = 5) +
  scale_color_manual(
    values = c("Top 6 Anomalous" = "red", "Maximum % of Transaction Failure" = "#088F8F"),
    labels = c("Top 6 Anomalous" = "Top 6 Anomalous", "Maximum % of Transaction Failure" = "Maximum % of Transaction Failure")
  ) +
  labs(title = "Failed Transactions by Hour with Anomalous Transactions in Red", 
       x = "Hour (72)", 
       y = "Failed Transactions Per Hour") +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 7), 
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    panel.grid.major.x = element_line(color = "lightgray", linewidth = 0.1),  # Very thin major x grid lines
    panel.grid.minor.x = element_line(color = "lightgray", linewidth = 0.1),  # Very thin minor x grid lines
    panel.grid.major.y = element_blank(), 
    legend.position = c(0.09, 0.9),  
    legend.background = element_rect(fill = "white", color = "black", size = 0.1),  
    legend.key.size = unit(0.01, "lines"),  
    legend.title = element_blank(),  # Remove legend title
    legend.text = element_text(size = 6)
  )

ggsave("failed_transactions_plot835.png", plot = last_plot(), width = 10, height = 6, dpi = 300)

```

The table is the top 6 anomalies, the red dots in the plot of transactions failures per hour are these top 6 anomalies. 

This is a sports event gambling service, the top 6 anomalies all occurred from users failure to repay gambling debts.
All delinquent users in these observations used the exact same Payment Gateway, Payment Method, sub-type, and bank which 
cannot be a coincidence. Delinquent users most likely used this combination of services as an exploit, perhaps to avoid 
repayment. 

In futher explanation: the dips in the failed transaction curve is simply lack of consumer activity overnight. 
```{r}

failed_transactions_per_hour_anamoly <- failed_transactions_per_hour[anamolous$index]
failed_transactions <- data.frame(hours = unique_hours, failedTransactions = percentage_of_failed_transactions_per_hour, x_index = seq(1:72))
anomalous_data <- data.frame(hour_anamoly = anamolous$index, FailedTransactions_anamoly = percentage_of_failed_transactions_per_hour[anamolous$index])

ggplot(data = failed_transactions, aes(x = x_index, y = failedTransactions)) + 
  geom_area(fill = "blue", alpha = 0.25) + 
  geom_line(color = "black") +  
  scale_x_continuous(
    breaks = seq(1, 72, by = 6),  # Major breaks every 6 units for labels
    minor_breaks = 1:72,  # Minor breaks to show all grid lines
    labels = unique_hours[seq(1, length(unique_hours), by = 6)]
  ) + 
  coord_cartesian(ylim = c(0.26, 0.48)) +  
  geom_point(data = anomalous_data, aes(x = hour_anamoly, y = FailedTransactions_anamoly),
             color = "red", size = 2) + 
  geom_point(aes(x = 45, y = 0.4553846), color = "#088F8F", size = 5) +
  labs(title = "Failed Transactions Percentage by Hour with Anomalous Transactions in Red", 
       x = "Hour (72)", 
       y = "Failed Transactions Per Hour") +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 5), 
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    panel.grid.major.x = element_line(color = "gray", linewidth = 0.1),  # Thin major x grid lines
    panel.grid.minor.x = element_line(color = "lightgray", linewidth = 0.05),  # Even thinner minor x grid lines
    panel.grid.major.y = element_blank(), 
    legend.position = c(0.09, 0.9),  
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  
    legend.key.size = unit(0.01, "lines"),  
    legend.title = element_blank(),  
    legend.text = element_text(size = 6)
  )




ggsave("percentage_failed_transactions_plot.png", plot = last_plot(), width = 10, height = 6, dpi = 300)

```



The big green dot is where failed transactions percentage is at it's maximum 
